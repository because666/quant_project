import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import tushare as ts
from datetime import datetime, timedelta

# ---------------------- å…¨å±€é…ç½® ----------------------
plt.rcParams["font.sans-serif"] = ["SimHei", "WenQuanYi Micro Hei", "Heiti TC", "Arial Unicode MS"]
plt.rcParams["axes.unicode_minus"] = False
plt.rcParams["figure.facecolor"] = "white"

TUSHARE_TOKEN = "è¿™é‡Œå†™è‡ªå·±çš„token"  # æ›¿æ¢ä¸ºä½ çš„Token
INDEX_CODE = "000001.SH"
BACKTEST_YEARS = 3
TRANSACTION_COST = 0.001
MA_SHORT = 5
MA_LONG = 20
MA_LONGER = 60
RSI_PERIOD = 14


# ---------------------- 1. æ•°æ®è·å–ä¸é¢„å¤„ç† ----------------------
def init_tushare(token: str) -> ts.pro_api or None:
    if not isinstance(token, str) or len(token) < 30:
        print("âŒ è¯·è¾“å…¥æœ‰æ•ˆTushare Tokenï¼ˆé•¿åº¦â‰¥30ä½ï¼‰")
        return None
    try:
        ts.set_token(token)
        pro = ts.pro_api()
        pro.index_basic(ts_code=INDEX_CODE, limit=1)
        print("âœ… Tushare Pro APIåˆå§‹åŒ–æˆåŠŸ")
        return pro
    except Exception as e:
        error_msg = str(e).lower()
        if "invalid token" in error_msg:
            print(f"âŒ Tokenæ— æ•ˆï¼šè¯·æ£€æŸ¥Tokenæ˜¯å¦æ­£ç¡®")
        elif "insufficient points" in error_msg:
            print(f"âŒ ç§¯åˆ†ä¸è¶³ï¼šindex_dailyæ¥å£éœ€2000ç§¯åˆ†")
        else:
            print(f"âŒ APIåˆå§‹åŒ–å¤±è´¥ï¼š{str(e)}")
        return None


def get_index_data(pro: ts.pro_api, index_code: str, years: int) -> pd.DataFrame or None:
    end_date = datetime.now().strftime("%Y%m%d")
    start_date = (datetime.now() - timedelta(days=years * 365)).strftime("%Y%m%d")
    try:
        df = pro.index_daily(
            ts_code=index_code,
            start_date=start_date,
            end_date=end_date,
            fields="trade_date,open,high,low,close"
        )
        if df.empty:
            print(f"âŒ æœªè·å–åˆ°{index_code}æ•°æ®")
            return None
        # å¤„ç†æ—¥æœŸæ ¼å¼å¹¶è½¬æ¢ä¸ºä¸­æ–‡åˆ—å
        df = (df
              .assign(æ—¥æœŸ=pd.to_datetime(df["trade_date"], format="%Y%m%d"))
              .sort_values("æ—¥æœŸ")
              .drop_duplicates(subset="æ—¥æœŸ")
              .rename(columns={
            "open": "å¼€ç›˜ä»·",
            "high": "æœ€é«˜ä»·",
            "low": "æœ€ä½ä»·",
            "close": "æ”¶ç›˜ä»·"
        })
              .drop(columns=["trade_date"])
              .set_index("æ—¥æœŸ")
              )
        trade_days = len(df)
        expected_min = years * 240
        if trade_days < expected_min * 0.5:
            print(f"âš ï¸ æ•°æ®é‡ä¸è¶³ï¼ˆ{trade_days}æ¡ï¼‰ï¼Œå¯èƒ½å½±å“å›æµ‹å‡†ç¡®æ€§")
        print(f"âœ… æˆåŠŸè·å–{index_code}æ•°æ®ï¼š{trade_days}æ¡ï¼ˆ{df.index[0].date()}è‡³{df.index[-1].date()}ï¼‰")
        return df
    except Exception as e:
        print(f"âŒ æ•°æ®è·å–å¤±è´¥ï¼š{str(e)}")
        return None


# ---------------------- 2. æŠ€æœ¯æŒ‡æ ‡è®¡ç®— ----------------------
def calculate_indicators(df: pd.DataFrame) -> pd.DataFrame or None:
    if df is None or df.empty or "æ”¶ç›˜ä»·" not in df.columns:
        print("âŒ æ— æœ‰æ•ˆæ•°æ®è®¡ç®—æŒ‡æ ‡")
        return None
    df_copy = df.copy()
    # å‡çº¿ï¼ˆä¸­æ–‡åˆ—åï¼‰
    df_copy[f"{MA_SHORT}æ—¥å‡çº¿"] = df_copy["æ”¶ç›˜ä»·"].rolling(MA_SHORT, min_periods=1).mean()
    df_copy[f"{MA_LONG}æ—¥å‡çº¿"] = df_copy["æ”¶ç›˜ä»·"].rolling(MA_LONG, min_periods=1).mean()
    df_copy[f"{MA_LONGER}æ—¥å‡çº¿"] = df_copy["æ”¶ç›˜ä»·"].rolling(MA_LONGER, min_periods=1).mean()
    # MACDï¼ˆä¸­æ–‡åˆ—åï¼‰
    df_copy["EMA12"] = df_copy["æ”¶ç›˜ä»·"].ewm(span=12, adjust=False).mean()
    df_copy["EMA26"] = df_copy["æ”¶ç›˜ä»·"].ewm(span=26, adjust=False).mean()
    df_copy["DIFF"] = df_copy["EMA12"] - df_copy["EMA26"]
    df_copy["DEA"] = df_copy["DIFF"].ewm(span=9, adjust=False).mean()
    df_copy["MACD"] = 2 * (df_copy["DIFF"] - df_copy["DEA"])
    # RSIï¼ˆä¸­æ–‡åˆ—åï¼‰
    delta = df_copy["æ”¶ç›˜ä»·"].diff(1)
    gain = delta.where(delta > 0, 0)
    loss = -delta.where(delta < 0, 0)
    avg_gain = gain.ewm(RSI_PERIOD, adjust=False, min_periods=1).mean()
    avg_loss = loss.ewm(RSI_PERIOD, adjust=False, min_periods=1).mean()
    rs = avg_gain / (avg_loss + 1e-6)
    df_copy[f"RSI({RSI_PERIOD})"] = 100 - (100 / (1 + rs))

    # æ¸…ç†ä¸´æ—¶è®¡ç®—åˆ—
    df_copy = df_copy.drop(columns=["EMA12", "EMA26"])

    df_valid = df_copy.dropna()
    print(f"âœ… æŒ‡æ ‡è®¡ç®—å®Œæˆï¼š{len(df_valid)}æ¡æœ‰æ•ˆæ•°æ®ï¼ˆåˆ é™¤{len(df_copy) - len(df_valid)}æ¡æ— æ•ˆæ•°æ®ï¼‰")
    return df_valid


# ---------------------- 3. å¯è§†åŒ–åˆ†æ ----------------------
def plot_technical_analysis(df: pd.DataFrame):
    if df is None or df.empty:
        print("âŒ æ— æ•°æ®å¯å¯è§†åŒ–")
        return
    required = ["æ”¶ç›˜ä»·", f"{MA_SHORT}æ—¥å‡çº¿", f"{MA_LONG}æ—¥å‡çº¿", f"{MA_LONGER}æ—¥å‡çº¿", "DIFF", "DEA", "MACD",
                f"RSI({RSI_PERIOD})"]
    missing = [f for f in required if f not in df.columns]
    if missing:
        print(f"âŒ ç¼ºå°‘å­—æ®µï¼š{missing}ï¼Œæ— æ³•ç»˜å›¾")
        return
    fig, (ax1, ax2, ax3) = plt.subplots(3, 1, figsize=(15, 12), dpi=100, sharex=True)
    fig.suptitle(f"{INDEX_CODE}æŠ€æœ¯æŒ‡æ ‡åˆ†æ", fontsize=14, y=0.98)
    # ä»·æ ¼ä¸å‡çº¿
    ax1.plot(df["æ”¶ç›˜ä»·"], label="æ”¶ç›˜ä»·", linewidth=1.5, color="#1f77b4")
    ax1.plot(df[f"{MA_SHORT}æ—¥å‡çº¿"], label=f"{MA_SHORT}æ—¥å‡çº¿", alpha=0.8, color="#ff7f0e")
    ax1.plot(df[f"{MA_LONG}æ—¥å‡çº¿"], label=f"{MA_LONG}æ—¥å‡çº¿", alpha=0.8, color="#2ca02c")
    ax1.plot(df[f"{MA_LONGER}æ—¥å‡çº¿"], label=f"{MA_LONGER}æ—¥å‡çº¿", alpha=0.8, color="#d62728")
    ax1.set_title("ä»·æ ¼èµ°åŠ¿ä¸å‡çº¿ç³»ç»Ÿ", fontsize=12)
    ax1.grid(alpha=0.3)
    ax1.legend(loc="upper left")
    # MACD
    ax2.plot(df["DIFF"], label="DIFF", color="#1f77b4")
    ax2.plot(df["DEA"], label="DEA", color="#ff7f0e")
    ax2.bar(df.index, df["MACD"], width=0.8, alpha=0.5,
            color=np.where(df["MACD"] > 0, "#2ca02c", "#d62728"))
    ax2.axhline(0, color="black", linestyle="--", alpha=0.3)
    ax2.set_title("MACDæŒ‡æ ‡", fontsize=12)
    ax2.grid(alpha=0.3)
    ax2.legend(loc="upper left")
    # RSI
    ax3.plot(df[f"RSI({RSI_PERIOD})"], label=f"RSI({RSI_PERIOD})", color="#1f77b4")
    ax3.axhline(70, color="red", linestyle="--", alpha=0.5, label="è¶…ä¹°çº¿(70)")
    ax3.axhline(30, color="green", linestyle="--", alpha=0.5, label="è¶…å–çº¿(30)")
    ax3.set_title("RSIæŒ‡æ ‡", fontsize=12)
    ax3.grid(alpha=0.3)
    ax3.legend(loc="upper left")
    ax3.tick_params(axis="x", rotation=45)
    plt.tight_layout(rect=[0, 0.03, 1, 0.95])
    plt.show()


# ---------------------- 4. å‡çº¿äº¤å‰ç­–ç•¥å›æµ‹ ----------------------
def backtest_ma_cross(df: pd.DataFrame) -> pd.DataFrame or None:
    if df is None or df.empty:
        print("âŒ æ— æ•°æ®å¯å›æµ‹")
        return None
    ma_short_col = f"{MA_SHORT}æ—¥å‡çº¿"
    ma_long_col = f"{MA_LONG}æ—¥å‡çº¿"
    if ma_short_col not in df.columns or ma_long_col not in df.columns:
        print(f"âŒ ç¼ºå°‘å‡çº¿å­—æ®µï¼šéœ€{ma_short_col}å’Œ{ma_long_col}")
        return None

    df_result = df.copy()

    # 1. ç”Ÿæˆäº¤æ˜“ä¿¡å·ï¼ˆä¸­æ–‡åˆ—åï¼‰
    df_result["é‡‘å‰"] = (df_result[ma_short_col] > df_result[ma_long_col]) & \
                        (df_result[ma_short_col].shift(1) <= df_result[ma_long_col].shift(1))
    df_result["æ­»å‰"] = (df_result[ma_short_col] < df_result[ma_long_col]) & \
                        (df_result[ma_short_col].shift(1) >= df_result[ma_long_col].shift(1))
    df_result.loc[:, "äº¤æ˜“ä¿¡å·"] = 0  # 1=ä¹°å…¥, -1=å–å‡º, 0=æ— æ“ä½œ
    df_result.loc[df_result["é‡‘å‰"], "äº¤æ˜“ä¿¡å·"] = 1
    df_result.loc[df_result["æ­»å‰"], "äº¤æ˜“ä¿¡å·"] = -1

    # 2. è®¡ç®—æŒä»“ï¼ˆä¸­æ–‡åˆ—åï¼‰
    df_result["æŒä»“çŠ¶æ€"] = np.where(df_result["äº¤æ˜“ä¿¡å·"] == 1, 1,
                                     np.where(df_result["äº¤æ˜“ä¿¡å·"] == -1, 0, np.nan))
    df_result["æŒä»“çŠ¶æ€"] = df_result["æŒä»“çŠ¶æ€"].ffill().fillna(0)

    # 3. è®¡ç®—æ”¶ç›Šç‡ï¼ˆä¸­æ–‡åˆ—åï¼‰
    df_result["åŸºå‡†æ—¥æ”¶ç›Š"] = df_result["æ”¶ç›˜ä»·"].pct_change()
    df_result["ç­–ç•¥æ—¥æ”¶ç›Š"] = df_result["æŒä»“çŠ¶æ€"].shift(1) * df_result["åŸºå‡†æ—¥æ”¶ç›Š"]
    # æ‰£é™¤äº¤æ˜“æˆæœ¬
    df_result["ç­–ç•¥æ—¥æ”¶ç›Š"] -= df_result["äº¤æ˜“ä¿¡å·"].shift(1).apply(lambda x: TRANSACTION_COST if x == 1 else 0)

    # 4. è®¡ç®—å‡€å€¼å’Œç´¯è®¡æ”¶ç›Šï¼ˆä¸­æ–‡åˆ—åï¼‰
    df_result["ç­–ç•¥å‡€å€¼"] = (1 + df_result["ç­–ç•¥æ—¥æ”¶ç›Š"]).cumprod()
    df_result["åŸºå‡†å‡€å€¼"] = (1 + df_result["åŸºå‡†æ—¥æ”¶ç›Š"]).cumprod()
    df_result["ç­–ç•¥ç´¯è®¡æ”¶ç›Š"] = df_result["ç­–ç•¥å‡€å€¼"] - 1
    df_result["åŸºå‡†ç´¯è®¡æ”¶ç›Š"] = df_result["åŸºå‡†å‡€å€¼"] - 1

    # è¿‡æ»¤æ— æ•ˆæ•°æ®
    df_valid = df_result.dropna(subset=["ç­–ç•¥æ—¥æ”¶ç›Š"]).copy()
    if len(df_valid) == 0:
        print("âŒ æ— æœ‰æ•ˆå›æµ‹æ•°æ®")
        return None

    # 5. è®¡ç®—æ ¸å¿ƒç»©æ•ˆæŒ‡æ ‡
    total_days = len(df_valid)
    annual_days = 252
    final_strategy_net = df_valid["ç­–ç•¥å‡€å€¼"].iloc[-1]
    annual_return = (final_strategy_net) ** (annual_days / total_days) - 1

    # è®¡ç®—æœ€å¤§å›æ’¤
    df_valid.loc[:, "ç­–ç•¥å‡€å€¼æœ€å¤§å€¼"] = df_valid["ç­–ç•¥å‡€å€¼"].cummax()
    df_valid.loc[:, "å›æ’¤ç‡"] = (df_valid["ç­–ç•¥å‡€å€¼æœ€å¤§å€¼"] - df_valid["ç­–ç•¥å‡€å€¼"]) / df_valid["ç­–ç•¥å‡€å€¼æœ€å¤§å€¼"]
    max_drawdown = df_valid["å›æ’¤ç‡"].max()

    # å¤æ™®æ¯”ç‡
    daily_return_mean = df_valid["ç­–ç•¥æ—¥æ”¶ç›Š"].mean()
    daily_return_std = df_valid["ç­–ç•¥æ—¥æ”¶ç›Š"].std() + 1e-6
    sharpe_ratio = np.sqrt(annual_days) * daily_return_mean / daily_return_std

    # 6. å›æµ‹ç»“æœå¯è§†åŒ–
    plt.figure(figsize=(12, 6), dpi=100)
    plt.plot(df_valid["åŸºå‡†å‡€å€¼"], label=f"åŸºå‡†å‡€å€¼ï¼ˆ{INDEX_CODE}ï¼‰", color="#1f77b4", alpha=0.8)
    plt.plot(df_valid["ç­–ç•¥å‡€å€¼"], label=f"ç­–ç•¥å‡€å€¼ï¼ˆ{MA_SHORT}/{MA_LONG}æ—¥å‡çº¿äº¤å‰ï¼‰", color="#d62728", alpha=0.8)
    plt.axhline(y=1, color="black", linestyle="--", alpha=0.3, label="åˆå§‹å‡€å€¼ï¼ˆ1ï¼‰")
    plt.title("å‡çº¿äº¤å‰ç­–ç•¥å›æµ‹ç»“æœï¼ˆå‡€å€¼è§†è§’ï¼‰", fontsize=14)
    plt.xlabel("æ—¥æœŸ", fontsize=12)
    plt.ylabel("å‡€å€¼ï¼ˆåˆå§‹=1ï¼‰", fontsize=12)
    plt.grid(alpha=0.3)
    plt.legend(loc="upper left")
    plt.tick_params(axis="x", rotation=45)
    plt.tight_layout()
    plt.show()

    # 7. æ‰“å°å›æµ‹æ‘˜è¦
    print("\n" + "=" * 50)
    print("ğŸ“Š å‡çº¿äº¤å‰ç­–ç•¥å›æµ‹ç»“æœæ‘˜è¦")
    print("=" * 50)
    print(f"æµ‹è¯•æ ‡çš„: {INDEX_CODE}ï¼ˆ{MA_SHORT}æ—¥å‡çº¿äº¤å‰{MA_LONG}æ—¥å‡çº¿ï¼‰")
    print(f"æµ‹è¯•å‘¨æœŸ: {df_valid.index[0].date()} è‡³ {df_valid.index[-1].date()}ï¼ˆå…±{total_days}ä¸ªäº¤æ˜“æ—¥ï¼‰")
    print(f"äº¤æ˜“æˆæœ¬: {TRANSACTION_COST * 100:.2f}%ï¼ˆå•æ¬¡ä¹°å…¥æ‰£é™¤ï¼‰")
    print("-" * 50)
    print(f"åŸºå‡†ç´¯è®¡æ”¶ç›Š: {df_valid['åŸºå‡†ç´¯è®¡æ”¶ç›Š'].iloc[-1]:.2%}")
    print(f"ç­–ç•¥ç´¯è®¡æ”¶ç›Š: {df_valid['ç­–ç•¥ç´¯è®¡æ”¶ç›Š'].iloc[-1]:.2%}")
    print(f"ç­–ç•¥å¹´åŒ–æ”¶ç›Šç‡: {annual_return:.2%}")
    print(f"æœ€å¤§å›æ’¤: {max_drawdown:.2%}")
    print(f"å¤æ™®æ¯”ç‡: {sharpe_ratio:.2f}")
    print("=" * 50)
    trade_count = df_valid["äº¤æ˜“ä¿¡å·"].abs().sum()
    print(f"ğŸ“ˆ ç­–ç•¥äº¤æ˜“ç»Ÿè®¡ï¼šå…±{trade_count}æ¬¡äº¤æ˜“ï¼ˆå¹³å‡{total_days / trade_count:.0f}å¤©/æ¬¡ï¼‰")
    print("=" * 50 + "\n")

    return df_result


# ---------------------- ä¸»ç¨‹åº ----------------------
if __name__ == "__main__":
    try:
        pro = init_tushare(TUSHARE_TOKEN)
        df_index = get_index_data(pro, INDEX_CODE, BACKTEST_YEARS) if pro else None
        df_with_indicators = calculate_indicators(df_index) if df_index is not None else None

        if df_with_indicators is not None:
            plot_technical_analysis(df_with_indicators)
            backtest_result = backtest_ma_cross(df_with_indicators)

            if backtest_result is not None:
                # ä¼˜åŒ–Excelå¯¼å‡ºæ ¼å¼ï¼Œç¡®ä¿æ—¥æœŸæ­£ç¡®æ˜¾ç¤º
                file_name = f"{INDEX_CODE}_å‡çº¿äº¤å‰å›æµ‹ç»“æœ.xlsx"
                with pd.ExcelWriter(file_name, engine="openpyxl") as writer:
                    # å°†ç´¢å¼•è½¬æ¢ä¸ºåˆ—ä»¥ä¾¿Excelæ­£ç¡®è¯†åˆ«æ—¥æœŸæ ¼å¼
                    df_export = backtest_result.reset_index()
                    df_export.to_excel(writer, index=False)

                    # è°ƒæ•´æ—¥æœŸåˆ—æ ¼å¼ä¸ºæ—¥æœŸç±»å‹
                    worksheet = writer.sheets['Sheet1']
                    date_col = df_export.columns.get_loc('æ—¥æœŸ') + 1  # openpyxlåˆ—ç´¢å¼•ä»1å¼€å§‹
                    for row in range(2, len(df_export) + 2):  # ä»ç¬¬äºŒè¡Œå¼€å§‹ï¼ˆè·³è¿‡è¡¨å¤´ï¼‰
                        worksheet.cell(row=row, column=date_col).number_format = 'yyyy-mm-dd'

                print(f"ğŸ’¾ å›æµ‹ç»“æœå·²ä¿å­˜è‡³ï¼š{file_name}")
    except Exception as e:
        print(f"\nâš ï¸ ç¨‹åºæ‰§è¡Œä¸­å‡ºç°å¼‚å¸¸ï¼š{str(e)}")
        if 'backtest_result' in locals() and backtest_result is not None:
            backup_name = f"{INDEX_CODE}_å‡çº¿äº¤å‰å›æµ‹ç»“æœ_å¤‡ä»½.xlsx"
            with pd.ExcelWriter(backup_name, engine="openpyxl") as writer:
                df_export = backtest_result.reset_index()
                df_export.to_excel(writer, index=False)
            print(f"ğŸ’¾ å·²å¤‡ä»½å›æµ‹ç»“æœè‡³ï¼š{backup_name}")
