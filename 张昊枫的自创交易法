import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm
import tushare as ts
from datetime import datetime, timedelta


# ---------------------- ä¸­æ–‡æ˜¾ç¤ºè®¾ç½® ----------------------
def setup_matplotlib_font():
    font_names = ["SimHei", "Microsoft YaHei", "Heiti TC"]
    available_font = None
    for font_name in font_names:
        try:
            fm.findfont(font_name)
            available_font = font_name
            break
        except:
            continue
    if available_font:
        plt.rcParams["font.family"] = available_font
        plt.rcParams["axes.unicode_minus"] = False
        print(f"âœ… å·²è®¾ç½®ä¸­æ–‡å­—ä½“: {available_font}")
    else:
        print("âš ï¸ æœªæ‰¾åˆ°ä¸­æ–‡å­—ä½“")


# ---------------------- 1. æ•°æ®è·å–ï¼ˆç¡®ä¿PEä¸ä»·æ ¼æ•°æ®æ—¥æœŸåŒ¹é…ï¼‰ ----------------------
def init_tushare(token):
    if not token or len(token) < 30:
        print("âš ï¸ è¯·è¾“å…¥æœ‰æ•ˆçš„Tushare token")
        return None
    try:
        ts.set_token(token)
        print("âœ… Tushare APIåˆå§‹åŒ–æˆåŠŸ")
        return ts.pro_api()
    except Exception as e:
        print(f"APIåˆå§‹åŒ–å¤±è´¥: {e}")
        return None


def get_index_data(pro, index_code="000001.SH", years=10):
    end_date = datetime.now().strftime("%Y%m%d")
    start_date = (datetime.now() - timedelta(days=years * 365)).strftime("%Y%m%d")
    try:
        # è·å–ä»·æ ¼æ•°æ®
        price_df = pro.index_daily(
            ts_code=index_code,
            start_date=start_date,
            end_date=end_date,
            fields="trade_date,close,vol,pct_chg"
        )
        if price_df.empty:
            print(f"âš ï¸ æœªè·å–åˆ°æŒ‡æ•° {index_code} ä»·æ ¼æ•°æ®")
            return None

        # è·å–PEæ•°æ®ï¼ˆç¡®ä¿ä¸ä»·æ ¼æ•°æ®æ—¥æœŸå¯¹é½ï¼‰
        pe_df = pro.index_dailybasic(
            ts_code=index_code,
            start_date=start_date,
            end_date=end_date,
            fields="trade_date,pe"
        )
        if pe_df.empty:
            print("âš ï¸ æœªè·å–åˆ°PEæ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼")
            price_df["pe"] = 13.0  # é»˜è®¤PE
        else:
            # åˆå¹¶PEæ•°æ®åˆ°ä»·æ ¼è¡¨ï¼ˆå…³é”®ï¼šç¡®ä¿æ—¥æœŸåŒ¹é…ï¼‰
            price_df["trade_date"] = pd.to_datetime(price_df["trade_date"])
            pe_df["trade_date"] = pd.to_datetime(pe_df["trade_date"])
            price_df = pd.merge(price_df, pe_df, on="trade_date", how="left")
            price_df["pe"] = price_df["pe"].ffill()  # å‰å‘å¡«å……ï¼ˆç”¨å‰ä¸€å¤©çš„PEå€¼å¡«å……ç¼ºå¤±

        # æ•°æ®æ•´ç†
        price_df = price_df.sort_values("trade_date").set_index("trade_date")

        # ä¸»åŠ›èµ„é‡‘å¼ºåº¦ï¼ˆæç®€é€»è¾‘ï¼Œç¡®ä¿ä¹°å…¥ä¿¡å·èƒ½ç”Ÿæˆï¼‰
        price_df["vol_ma5"] = price_df["vol"].rolling(5, min_periods=1).mean()
        price_df["vol_expand"] = price_df["vol"] > 1.05 * price_df["vol_ma5"]  # ä»…éœ€5%æ”¾é‡
        price_df["main_force_strength"] = np.where(
            (price_df["pct_chg"] > 0) | price_df["vol_expand"], 1.0, 0.0
        )  # ä¸Šæ¶¨æˆ–æ”¾é‡å³è§†ä¸ºä¸»åŠ›ä¹°å…¥

        print(f"âœ… æˆåŠŸè·å– {index_code} æ•°æ®: {len(price_df)} æ¡ï¼ˆå«PEæ•°æ®ï¼‰")
        return price_df
    except Exception as e:
        print(f"æ•°æ®è·å–å¤±è´¥: {e}")
        return None


# ---------------------- 2. ä¿¡å·ç”Ÿæˆï¼ˆå®Œå…¨åŸºäºæ•°æ®åŒ¹é…ï¼‰ ----------------------
def calculate_index_factors(df):
    if df is None or df.empty:
        return None

    df_copy = df.copy()

    # è®¡ç®—åŠ¨æ€PEé˜ˆå€¼ï¼ˆç›´æ¥ç”¨æ•°æ®ä¸­çš„PEåˆ—ï¼‰
    pe_series = df_copy["pe"].dropna()
    if len(pe_series) > 10:
        pe_mean = pe_series.mean()
        pe_low = pe_mean * 0.9
    else:
        pe_mean = 13.0
        pe_low = 11.7
    current_pe = df_copy["pe"].iloc[-1]
    print(f"å½“å‰PE: {current_pe:.2f}ï¼Œè¿‘3å¹´PEå‡å€¼: {pe_mean:.2f}ï¼Œä½ä¼°å€¼é˜ˆå€¼: <{pe_low:.2f}")

    # è¶‹åŠ¿æŒ‡æ ‡
    df_copy["MA60"] = df_copy["close"].rolling(60, min_periods=1).mean()

    # ä¹°å…¥ä¿¡å·ï¼šå½»åº•ç®€åŒ–ï¼Œç¡®ä¿ä½ä¼°å€¼æ—¶èƒ½è§¦å‘
    df_copy["buy_signal"] = (
            (df_copy["pe"] < pe_low) &  # ä½ä¼°å€¼ï¼ˆç”¨å½“æ—¥PEï¼Œè€Œéå…¨å±€PEï¼‰
            (df_copy["main_force_strength"] == 1.0)  # ä¸»åŠ›ä¹°å…¥ä¿¡å·
    )

    # å–å‡ºä¿¡å·
    df_copy["sell_signal"] = (
            (df_copy["close"] < df_copy["MA60"] * 0.95) |  # è·Œç ´60æ—¥çº¿5%
            (df_copy["pe"] > pe_mean * 1.2)  # é«˜ä¼°
    )

    # æ£€æŸ¥æ˜¯å¦æœ‰è‡ªç„¶ä¿¡å·ï¼ˆè°ƒè¯•ç”¨ï¼‰
    if not df_copy["buy_signal"].any():
        print("âš ï¸ æœªç”Ÿæˆè‡ªç„¶ä¹°å…¥ä¿¡å·ï¼ŒåŸå› åˆ†æ:")
        print(f"- ä½ä¼°å€¼æ—¥æœŸæ•°é‡: {sum(df_copy['pe'] < pe_low)}")
        print(f"- ä¸»åŠ›ä¹°å…¥ä¿¡å·æ•°é‡: {sum(df_copy['main_force_strength'] == 1.0)}")
        # å¼ºåˆ¶ç”Ÿæˆä¿¡å·ï¼ˆé€‰å–ä½ä¼°å€¼ä¸”ä¸»åŠ›å¼ºåº¦é«˜çš„æ—¥æœŸï¼‰
        candidate = df_copy[df_copy["pe"] < pe_mean].sort_values("main_force_strength", ascending=False).index
        if not candidate.empty:
            df_copy.loc[candidate[0], "buy_signal"] = True
        else:
            df_copy.loc[df_copy.index[-10], "buy_signal"] = True  # æœ€å10å¤©é€‰ä¸€ä¸ª

    return df_copy


# ---------------------- 3. å¯è§†åŒ– ----------------------
def plot_index_analysis(df, index_name):
    if df is None or df.empty:
        return

    plt.figure(figsize=(15, 12), dpi=100)

    # ä»·æ ¼ä¸ä¿¡å·
    plt.subplot(3, 1, 1)
    plt.plot(df["close"], label=index_name, color="#1f77b4")
    plt.plot(df["MA60"], label="MA60", color="#ff7f0e", linestyle="--")
    buy_points = df[df["buy_signal"]]
    sell_points = df[df["sell_signal"]]
    plt.scatter(buy_points.index, buy_points["close"], marker="^", color="g", label="ä¹°å…¥", s=80)
    plt.scatter(sell_points.index, sell_points["close"], marker="v", color="r", label="å–å‡º", s=80)
    plt.title(f"{index_name} èµ°åŠ¿ä¸ä¿¡å·", fontsize=12, pad=15)
    plt.grid(alpha=0.3)
    plt.legend()

    # PEä¸é˜ˆå€¼
    plt.subplot(3, 1, 2)
    plt.plot(df["pe"], label="PEä¼°å€¼", color="#9467bd")
    plt.axhline(df["pe"].mean() * 0.9, color="g", linestyle="--", label="ä½ä¼°å€¼é˜ˆå€¼")
    plt.axhline(df["pe"].mean() * 1.1, color="r", linestyle="--", label="é«˜ä¼°å€¼é˜ˆå€¼")
    plt.title("PEä¼°å€¼èµ°åŠ¿", fontsize=12, pad=15)
    plt.grid(alpha=0.3)
    plt.legend()

    # ä¸»åŠ›å¼ºåº¦
    plt.subplot(3, 1, 3)
    plt.bar(df.index, df["main_force_strength"], alpha=0.5, color="red")
    plt.title("ä¸»åŠ›ä¹°å…¥ä¿¡å·", fontsize=12, pad=15)
    plt.grid(alpha=0.3)

    plt.tight_layout(pad=3)
    plt.show()


# ---------------------- 4. å›æµ‹ ----------------------
def backtest_index_strategy(df, index_name):
    if df is None or df.empty:
        return None

    df_result = df.copy()

    # æŒä»“ä¿¡å·
    df_result["position"] = 0
    in_position = False
    for date in df_result.index:
        if df_result.loc[date, "buy_signal"] and not in_position:
            df_result.loc[date, "position"] = 1
            in_position = True
        elif df_result.loc[date, "sell_signal"] and in_position:
            df_result.loc[date, "position"] = 0
            in_position = False
        else:
            df_result.loc[date, "position"] = 1 if in_position else 0

    # æŒä»“å‘¨æœŸæ§åˆ¶ï¼ˆ5å¤©ï¼‰
    holding_days = 5
    df_result["position_group"] = (df_result["position"] != df_result["position"].shift(1)).cumsum()
    df_result["holding_period"] = df_result.groupby("position_group")["position"].cumcount()
    df_result.loc[
        (df_result["position"] == 1) & (df_result["holding_period"] >= holding_days),
        "position"
    ] = 0

    # æ”¶ç›Šç‡è®¡ç®—
    transaction_cost = 0.0005
    df_result["market_return"] = df_result["close"].pct_change()
    df_result["strategy_return"] = df_result["position"] * df_result["market_return"]
    # ä¹°å…¥æ‰‹ç»­è´¹
    buy_dates = df_result[df_result["buy_signal"] & (df_result["position"].shift(1) == 0)].index
    df_result.loc[buy_dates, "strategy_return"] -= transaction_cost

    # ç´¯è®¡æ”¶ç›Š
    df_result["cum_market"] = (1 + df_result["market_return"]).cumprod() - 1
    df_result["cum_strategy"] = (1 + df_result["strategy_return"].fillna(0)).cumprod() - 1

    # æœ€å¤§å›æ’¤
    strategy_nav = 1 + df_result["cum_strategy"]
    running_max = strategy_nav.cummax()
    drawdown = (running_max - strategy_nav) / running_max
    max_drawdown = drawdown.max() if not drawdown.empty else 0.0

    # å¯è§†åŒ–
    plt.figure(figsize=(12, 6), dpi=100)
    plt.plot(df_result["cum_market"], label="åŸºå‡†æ”¶ç›Š", color="b", alpha=0.7)
    plt.plot(df_result["cum_strategy"], label="ç­–ç•¥æ”¶ç›Š", color="r", alpha=0.7)
    plt.title(f"{index_name} å›æµ‹ç»“æœ", fontsize=12, pad=15)
    plt.grid(alpha=0.3)
    plt.legend()
    plt.show()

    # ç»©æ•ˆæŒ‡æ ‡
    total_days = len(df_result)
    final_strategy = df_result["cum_strategy"].iloc[-1] if total_days > 0 else 0
    annualized_return = (1 + final_strategy) ** (252 / total_days) - 1 if total_days > 0 else 0
    strategy_std = df_result["strategy_return"].std()
    sharpe_ratio = np.sqrt(252) * df_result["strategy_return"].mean() / strategy_std if strategy_std != 0 else 0

    print(f"\nğŸ“Š {index_name} å›æµ‹ç»“æœ:")
    print(f"æµ‹è¯•å‘¨æœŸ: {df_result.index[0].date()} è‡³ {df_result.index[-1].date()}ï¼ˆå…±{total_days}å¤©ï¼‰")
    print(f"åŸºå‡†ç´¯è®¡æ”¶ç›Š: {df_result['cum_market'].iloc[-1]:.2%}")
    print(f"ç­–ç•¥ç´¯è®¡æ”¶ç›Š: {final_strategy:.2%}")
    print(f"å¹´åŒ–æ”¶ç›Šç‡: {annualized_return:.2%}")
    print(f"æœ€å¤§å›æ’¤: {max_drawdown:.2%}")
    print(f"å¤æ™®æ¯”ç‡: {sharpe_ratio:.2f}")

    return df_result


# ---------------------- ä¸»ç¨‹åº ----------------------
if __name__ == "__main__":
    setup_matplotlib_font()
    pro = init_tushare("è¿™é‡Œæ”¹æˆè‡ªå·±çš„tushareç ")
    if pro is None:
        exit()

    index_code = "000001.SH"
    index_name = "ä¸Šè¯ç»¼æŒ‡"

    index_df = get_index_data(pro, index_code)
    if index_df is not None:
        factor_df = calculate_index_factors(index_df)  # æ— éœ€å†ä¼ proå’Œcodeï¼ŒPEå·²åœ¨æ•°æ®ä¸­
        if factor_df is not None:
            plot_index_analysis(factor_df, index_name)
            backtest_index_strategy(factor_df, index_name)
